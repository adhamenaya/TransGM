<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polygon Area Calculator</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #header {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-align: center;
        }
        #map {
            flex-grow: 1;
            width: 100%;
        }
        #controls {
            padding: 10px;
            background-color: #f8f8f8;
            border-top: 1px solid #ddd;
        }
        .info-box {
            padding: 8px;
            margin: 10px 0;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            margin-right: 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button.active {
            background-color: #2E7D32;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        #area-display {
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="header">
        <h2>Polygon Area Calculator</h2>
    </div>

    <div id="map"></div>

    <div id="controls">
        <div class="info-box">
            <p>Click on the map to create polygon vertices. The area will be calculated automatically.</p>
            <div id="area-display">Area: 0 square meters</div>
        </div>
        <button id="clear-btn">Clear Polygon</button>
        <button id="finish-btn">Finish Polygon</button>
        <button id="square-btn">Draw 3km x 3km Square</button>
        <span>(Click on map to set center point after activating)</span>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<!-- Turf.js for area calculations -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>

<script>
    // Initialize the map
    const map = L.map('map').setView([40.7128, -74.0060], 13); // Default to NYC

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Try to get user's location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                map.setView([position.coords.latitude, position.coords.longitude], 13);
            },
            (error) => {
                console.log('Geolocation error:', error);
            }
        );
    }

    // Variables to store polygon data
    let vertices = [];
    let polyline = null;
    let polygon = null;
    let markers = [];

    // Event handlers
    let drawingMode = 'freeform'; // Can be 'freeform' or 'square'

    map.on('click', (e) => {
        if (drawingMode === 'freeform') {
            addVertex(e);
        } else if (drawingMode === 'square') {
            createSquare(e.latlng);
            drawingMode = 'freeform'; // Reset to freeform mode after drawing the square
            document.getElementById('square-btn').classList.remove('active');
        }
    });

    document.getElementById('clear-btn').addEventListener('click', clearPolygon);
    document.getElementById('finish-btn').addEventListener('click', finishPolygon);
    document.getElementById('square-btn').addEventListener('click', () => {
        clearPolygon();
        drawingMode = 'square';
        document.getElementById('square-btn').classList.add('active');
        alert('Now click on the map to create a 3km x 3km square centered at the clicked point');
    });

    // Add a vertex to the polygon
    function addVertex(e) {
        const latlng = e.latlng;
        vertices.push([latlng.lat, latlng.lng]);

        // Add marker
        const marker = L.marker(latlng, {
            draggable: true
        }).addTo(map);
        marker.on('drag', updatePolygon);
        markers.push(marker);

        // Update the polyline/polygon
        updatePolygon();
    }

    // Update the polygon when vertices change
    function updatePolygon() {
        // Update vertices from markers
        vertices = markers.map(marker => {
            const pos = marker.getLatLng();
            return [pos.lat, pos.lng];
        });

        // If we have a polyline already, remove it
        if (polyline) {
            map.removeLayer(polyline);
        }

        // If we have a polygon already, remove it
        if (polygon) {
            map.removeLayer(polygon);
        }

        // If we have at least 2 vertices, show a polyline
        if (vertices.length >= 2) {
            polyline = L.polyline(vertices, {color: 'blue'}).addTo(map);
        }

        // If we have at least 3 vertices, show a polygon and calculate area
        if (vertices.length >= 3) {
            // Create a closed polygon for display
            const polygonVertices = [...vertices];
            if (polygonVertices[0][0] !== polygonVertices[polygonVertices.length-1][0] ||
                polygonVertices[0][1] !== polygonVertices[polygonVertices.length-1][1]) {
                polygonVertices.push(polygonVertices[0]);
            }

            polygon = L.polygon(vertices, {color: 'green', fillOpacity: 0.3}).addTo(map);

            // Calculate area using turf.js
            // Convert to GeoJSON format for turf
            const polygonCoords = vertices.map(vertex => [vertex[1], vertex[0]]);
            polygonCoords.push(polygonCoords[0]); // Close the polygon

            const polygonGeoJSON = turf.polygon([polygonCoords]);
            const area = turf.area(polygonGeoJSON);

            // Display the area
            document.getElementById('area-display').textContent = `Area: ${formatArea(area)}`;
        } else {
            document.getElementById('area-display').textContent = 'Area: 0 square meters';
        }
    }

    // Format area for display
    function formatArea(area) {
        if (area < 10000) {
            return `${area.toFixed(2)} square meters`;
        } else {
            const areaInSquareKm = area / 1000000;
            return `${areaInSquareKm.toFixed(4)} square kilometers (${area.toFixed(2)} square meters)`;
        }
    }

    // Clear the polygon
    function clearPolygon() {
        vertices = [];

        // Remove markers
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        // Remove polyline
        if (polyline) {
            map.removeLayer(polyline);
            polyline = null;
        }

        // Remove polygon
        if (polygon) {
            map.removeLayer(polygon);
            polygon = null;
        }

        document.getElementById('area-display').textContent = 'Area: 0 square meters';
    }

    // Finish the polygon (connect last point to first)
    function finishPolygon() {
        if (vertices.length >= 3) {
            // No need to add another vertex as we handle closing in updatePolygon
            updatePolygon();
        } else {
            alert('A polygon needs at least 3 vertices');
        }
    }

    // Create a 3km x 3km square centered at the provided point
    function createSquare(center) {
        clearPolygon();

        // Calculate corner points (1.5km in each direction)
        // Using approximate conversion: 0.01 degrees â‰ˆ 1.11km at equator
        // This is a simplified calculation that works best near the equator
        // For more accuracy at different latitudes, we use destination point calculation

        const squareSizeKm = 3; // Size of the square in km
        const halfSizeKm = squareSizeKm / 2;

        // Use turf.js to calculate points at exact distances
        const north = turf.destination(
            turf.point([center.lng, center.lat]),
            halfSizeKm,
            0,
            {units: 'kilometers'}
        );

        const east = turf.destination(
            turf.point([center.lng, center.lat]),
            halfSizeKm,
            90,
            {units: 'kilometers'}
        );

        const south = turf.destination(
            turf.point([center.lng, center.lat]),
            halfSizeKm,
            180,
            {units: 'kilometers'}
        );

        const west = turf.destination(
            turf.point([center.lng, center.lat]),
            halfSizeKm,
            270,
            {units: 'kilometers'}
        );

        // Calculate the four corners of the square
        const northEast = turf.destination(
            turf.point([east.geometry.coordinates[0], north.geometry.coordinates[1]]),
            0.1, // Small offset to ensure the point calculation is correct
            45,
            {units: 'kilometers'}
        );

        const southEast = turf.destination(
            turf.point([east.geometry.coordinates[0], south.geometry.coordinates[1]]),
            0.1,
            135,
            {units: 'kilometers'}
        );

        const southWest = turf.destination(
            turf.point([west.geometry.coordinates[0], south.geometry.coordinates[1]]),
            0.1,
            225,
            {units: 'kilometers'}
        );

        const northWest = turf.destination(
            turf.point([west.geometry.coordinates[0], north.geometry.coordinates[1]]),
            0.1,
            315,
            {units: 'kilometers'}
        );

        // Add the vertices in order to form a square
        const square = [
            [northEast.geometry.coordinates[1], northEast.geometry.coordinates[0]],
            [southEast.geometry.coordinates[1], southEast.geometry.coordinates[0]],
            [southWest.geometry.coordinates[1], southWest.geometry.coordinates[0]],
            [northWest.geometry.coordinates[1], northWest.geometry.coordinates[0]]
        ];

        // Add each vertex to the map
        square.forEach(coord => {
            const marker = L.marker([coord[0], coord[1]], {
                draggable: true
            }).addTo(map);
            marker.on('drag', updatePolygon);
            markers.push(marker);
            vertices.push(coord);
        });

        // Update the polygon display
        updatePolygon();
    }
</script>
</body>
</html>